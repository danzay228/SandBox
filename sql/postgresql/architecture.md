# PostgreSQL

## Общее устройство
Клиет-серверная модель:
Клиет+драйвер <---> СУБД

### Транзакции
*Транакция* - последовательность опреаций, которая сохраняет согластованность данных при условии, что операции выполнены полностью и без помех со стороны других транзакций.

`BEGIN - COMMIT/ROLLBACK`

**ACID**:
- атомарность (все или ничего)
- согласованость (ограничения целостности и пользовательские ограничения)
- изоляция (влияние параллельных процессов)
- долговечность (сохранность данных даже после сбоя)

**Статус транзакции** (2 бита на транзакцию)
- активна
- завершена
  - фиксация
  - обрыв

Статусы храняться (commit log, clog) в каталоге `PGDATA/pg_xact`, а работа происходит в *общей памяти* 

### Запрос
- разбор (в качестве иточника мета-информации ипользуется [системный каталог](./data_organization.md#системный-каталог)) - статический (правильность слов, комманд) и семантический (налачие таблиц, имен и т.п.)
- переписывание (механизм **правил**) - замена представлений на запросы и т.п.
- планирование (**статистика** содержит необходимую информацию о размере таблиц и распределении в них данных) - сосотовление плана выполнения поиска и группировки данных на основе запроса.
- выполненеие (возвращает **данные**)

Можно реализовать заранее **подготовленные операторы** - параметризованные часто используемые запросы, которые уже содержат готовые результаты *разбора*, *переписывания* и *планирования*.

### Курсоры
Механизм для посторочной работы с полученными результатами

### Процессы и память
`postmaster` - базовый процесс создающий и контролирующий:
- общей памятю
- фоновыми [процессами](#процессы) БД
- клиетскими процессами с их локальной памятью

### Пул соединений
- Множество клиентов требуют механизмы **многоверсионности данных (MVCC)** и **изоляцию на основе снимков данных**
- Если клиентов очень много используется пул соединений, объеденяющий множество клиентов приводя их к небольшому количеству

### Хранение данных
- данные зраняться в файлайх ОС
- файлы разделенны на страницы (обычно 8КБ), страницы имеют разметку на заголовки и данные
- буфферный кеш распологается *общей памяти* и хранит страницы с которыми недавно работали (+ есть кеш ОС, который также может предоставлять недавние страницы)

## Изоляция и Многоверсионность

### Многоверсионность
- если обе читающих - проблем нет
- если обе пишущих - то поздняя перезаписывает ранюю
- сложность в организации работы пишущей и читающей -> поэтому используется несколько версий

В PostgreSQL применяеться изоляция на основе *снимка данных*

### Снимок данных
- номер последнейтранзакции, на момент создания снимка
- список активных транзакций на этот момент

### Уровни изоляции
- `Read Uncommitted` (не поддерживается, работает как Read Commited)
- `Read Commited` (по умолчанию)
  - снимок строится на момент начала опертора
  - одинаковые запросы могут каждый раз получат разные данны
- `Repeatable Read`
  - снимок строится на момент начала первого оператора транзакции
  - транзакция может завршиться ошибкой сериализации
- `Serializable`
  - полная изоляция, но дополнительные накладные расходы
  - транзакция может завршиться ошибкой сериализации

### Очистка
Удаление исторических данных - из таблиц вычищаются мертвые версии строк.
Выполняется с помощью `VACUUM` или `autovacuume` (процессом автоочистки)

### Блокировки
- Блокировки строк
  - чтение никогда не блокирует строки
  - изменение строк блокирует их для изменения, но не для чтения
- Блокировки таблиц
  - запрещает удаление, изменение, по с ней идет работа
  - запрещает чтение таблицы при перестроении или перемещении

*Время жизни блокировок* устананавливается по мере необходимости или вручную и снимаются автоматически при завершении транзакции

## Буфферный кеш и журнал

### Устройство буфферного кеша (ускоряет работу)
- Используется для сглаживания работы между оперативной памятью и диском
- Разбит на страницы данных (8КБ)
- все страницы проходят через буфферный кеш
- измененая страница - делает буффером в котором находится "грязным"
- "грязный" буффер подлежит записи на диск (может быть асинхронным т.к. контролируется отдельным процессом)
- при преполнени буфферного кеша используется **LRU алгоритм вытеснения**

### Журнал подзаписи (WAL) (обеспечивает надежность)
- write-ahead log
- `PGDATA/pg_wal`
- Решает проблему сохранности данных при сбоях системы
- Журналирует необходимый минимум информации о операциях для их воспроизведения
- защищает все объекты, работа с которыми ведется в оперативной памяти (таблицы, индексы, статусы транзакций, и другие объекты)

### Контрольная точка (ограничивает размер журнала)
- переодический сброс всех "грязных" буфферов на диск
  - гарантирует попадание на диск всех изменений до контрольной точки
  - ограничевает размер журнала, необходимого для восстановления
- восстановление при сбросе
  - начинается с последней контрольной точки
  - последовательно проигрываются записи (WAL журнала), если изменений нет на диске

### Производительность
Создание и восстановление контрольной точки может быть длительным процессом
- Синхронный режим (хорошая надежность)
  - запись при фиксации
  - обслуживающий процесс
- Асинхронный процесс (хорошая производительность)
  - фоновая запись
  - `walwriter`

### Процессы
- запись журнала (`walwriter`)
- контрольная точка (`checkpointer`) - сброс всех "грязных" буфферов
- фоновая запись (`bgwriter`) - сброс части "грязных" буфферов
- обслуживающие процессы - сброс вытесняемого "грязного" буфферов

### Уровни журнала (wal_level)
- Minimal - гарантия восстановления после сброса
- Replica (по умолчанию)
  - резервное копирование
  - репликация: передача и копирование журнала на другом сервере
- Logical
  - логическая реплекация: информация о добавлении, изменении и удалении табличных строк

## SQL
- представления - именнованые запросы
- триггеры
- функции
- процедуры
- составные типы
  - набор именованных атрибутов (полей)
  - то же, что табличная строка, но без ограничений целостности
  - использование:
    - аттрибуты как скалярные значения
    - удобны пр сравнениях, проверках
    - упращают функции, процедуры