# Планировщик

переключение между потоками ОС - требует переключение контекста и кеша
переключение меджу горутинами - не требует, т.к стек горутины на самом деле выделяется в куче...

**GMP**:
- Gorutine (что исполняем)
- Machine (абстракция машины)
- Processor (права и ресурсы для исполнения, содержит локальную lock-free очередь, LRQ=256)

1 поток ОС = Machine + Processor

Распределение горутин:
- Work Sharing (полный поток раздает пустым потокам свои горутины)
- **Work Stealing** (пустой поток делает 4 попытки забрать половину горутин из другого случайно потока)

Потоки содержащие **блокирующие системные вызовы**, в случае если их выполнение может затянуться, помещаются в **netpoller**. Для мониторинга осободившихся потоков используется абстракция над специфичной реализацией epoll для каждой из ОС. При особождении готовые к выполнению горутины помещаются в **глобалную очередь**. Каждый **61** обращение M+P берет поток из глобальной очереди. 

# Asyncronous Preemption (аснихронная вытесняющая многозадачность)
В случае обнаружения горутины, работающей более 10мс, в поток подается сигнал вытеснения (SIGURG) с помощью sysmon.

Основные компоненты планировщика:
- G+M+P
- Global Queue (GRQ)
- Wait Queue (WRQ in starving mode)
- sysmon
- netpoller

Источники:
- https://www.youtube.com/watch?v=P2Tzdg8n9hw
- https://www.youtube.com/watch?v=z9xXThOOMWc